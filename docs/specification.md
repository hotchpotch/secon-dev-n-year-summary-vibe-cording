# 仕様書

## 目的

secon.dev というサイトの、日記データを読み込み、同日に書かれた日記の過去の記事を遡って、過去どんな出来事があったかを毎年150〜200文字程度にまとめる。日記執筆者本人が過去の出来事を知ることによって、人生を振り返れ豊かなものにしていきたい。

## 技術仕様

- python 3.12 + uv でプロジェクトを構成する
- mac, linux で動くcli コマンド
- あなたはPythonのプロフェッショナルエンジニアで、可読性を意識し、適当な粒度で設計し、実装を分ける。
  - ちょうど良い粒度の抽象化を行う
- 並列処理にasync.ioを使う
- 処理するLLMは openai, gemini, claude どれかを選べる。
  - "openai/gpt-4.1-nano" などで、ベンダーとモデルを指定する
  - これらのライブラリは、オフィシャルのものを使う
  - 全てのAPI_KEYがなくとも良い。オプション引数のベンターが渡された時点で初期化すること
  - LLMのAPIは各社実装差異があるが、エラーハンドリングを適切に行うこと
- 記事の抽出には bs4 ライブラリを使う
  - 年ごとに記事本文と画像を抽出する
  - メタデータで、title, url も保持する
  - 画像はog:imageを使う
  - title や本文は、HTMLを確認して適切なものを考える。日記システムで作っているので、特定のclass tagなどがあるはず。
- 記事は "https://secon.dev/entry/2025/04/29/210000/" などに存在する。その日の日記がない場合、ない場合もある。2025, 04, 29 などが日付で可変である。"210000" は固定と考えて良い。
  - **更新: 対象日の記事から、.similar-entries .similar-thumb-entry内のaタグから過去の記事へのリンクを抽出し、同じ月日のものだけを取得する。対象日より古い、かつ指定された年数（デフォルト10年）以内の記事のみを対象とする。**
  - 記事は対象が2025/04/29なら、一年前の2024/04/29,2年前の2023/04/29...など過去N年分(default=10)を遡って取得する。対象年は含めなくて良い。
  - **更新: 対象日時がなければ、一年前の今日の日付とする。**
- LLMを使って、年ごとの記事を構造化したデータを渡して、振り返りができる文章を作る。振り返りは、以下のフォーマットが望ましい
- LLMでの生成以外はテストを書く
  - 例えばHTMLなどは、取得したいくつかのHTMLを元にmock化して、bs4での抽出処理をおこおなう、など

## 2024年4月29日 🍜

ラーメン横浜屋で、つけ麺を食べました。かなり好みの味で、また近々訪れたいと感じました。麺の太さとコシが絶妙で、スープも濃厚ながらくどさがなく、最後まで飽きずに完食。特に味玉の味付けが絶妙で感動しました。次回は違うメニューにも挑戦してみたいです。

## 2024年4月29日 🌊

大洗の海岸線を見ました。夕陽が美しく、何枚も写真を撮ったのですが、誤ってデータを消してしまい悲しかったです。それでも海風を感じながら過ごした時間は格別で、日常を忘れられるひとときでした。家族と一緒に行けたこともあり、素敵な思い出になりました。

...

- 作成したテキストは、output/texts/YYYYMMDD/{モデルベンダ}_{モデル名}.md に保存する
- 抽出した年毎の記事画像(unique)を使い、日付と複数の画像を含めたpng画像を作る。この画像は output/images/YYYYMMDD.png (YYYYMMDD は、対象とする日) に保存する。
  - 日本語を使うと文字化けするので、画像にフォントを埋め込む際は英語のみを使って。この画像は、人間が見た時にわかりやすい情報のレイアウトにして。できる限りマージンは入れないこと。
  - 各画像の右下に、記事の日付（YYYY.MM.DD形式）をオレンジ色の半透明小さめフォントで表示する。フォントサイズは12pxとする。
  - 画像上部のタイトル欄は表示しない。
  - 画像の背景色は #333333（ダークグレー）を使用する。
- 投稿先は discord, slack か stdout とする。
  - discord, slack の場合、discord や slackの webhook url を読み込むこと。各々別に設定できるようにすること。
  - メタデータ的なものも、その投稿で参照したい。メタデータとは、URLやタイトルのことである。
  - また、画像のpngも投稿したい。
- 記事と画像の順序は、新しい順（降順）に表示すること。

## オプション関連の設定

- API_KEY や WebHook URL などの、プロジェクトで普遍的なものは、環境変数として .env から読み込む。
- 対象日時(デフォルト当日)・LLMモデルの選択・過去に遡って何年分か・投稿先(複数指定可能・何も指定しないとstdout)などの、条件によって変わるものは、args として受け取る。argsは -m, --model など、短い記法も入れる。
