# 仕様書

## 目的

secon.dev というサイトの、日記データを読み込み、同日に書かれた日記の過去の記事を遡って、過去どんな出来事があったかを毎年150〜200文字程度にまとめる。日記執筆者本人が過去の出来事を知ることによって、人生を振り返れ豊かなものにしていきたい。

## 技術仕様

- python 3.12 + uv でプロジェクトを構成する
  - 依存関係の同期には `uv sync` を使用する
- mac, linux で動くcli コマンド (`secon-year-summary`)
- あなたはPythonのプロフェッショナルエンジニアで、可読性を意識し、適当な粒度で設計し、実装を分ける。
  - ちょうど良い粒度の抽象化を行う
- 並列処理に `asyncio` を使う
- 処理するLLMは openai, gemini, claude どれかを選べる。
  - `-m/--model` オプションで `"openai/gpt-4.1-nano"` のように、ベンダーとモデルを指定する (デフォルト: `"openai/gpt-4.1-nano"`)
  - これらのライブラリは、オフィシャルのものを使う
  - 全てのAPI_KEYがなくとも良い。オプション引数のベンターが渡された時点で初期化すること
  - LLMのAPIは各社実装差異があるが、エラーハンドリングを適切に行うこと
- 記事の抽出には `bs4` ライブラリを使う
  - 年ごとに記事本文と画像を抽出する
  - メタデータで、title, url も保持する
  - 画像はog:imageを使う
  - title や本文は、HTMLを確認して適切なものを考える。日記システムで作っているので、特定のclass tagなどがあるはず。
- 記事は `https://secon.dev/entry/YYYY/MM/DD/210000/` などに存在する。その日の日記がない場合、ない場合もある。YYYY, MM, DD などが日付で可変である。"210000" は固定と考えて良い。
  - **記事取得ロジック:** 対象日の記事ページ内にある `.similar-entries .similar-thumb-entry` セレクタ内の `a` タグから過去記事へのリンクを抽出する。
  - その中から、対象日と**同じ月日**の記事のみを取得する。
  - 対象日より古く、かつ指定された年数 (`-y/--years` オプション、デフォルト10年) 以内の記事のみを対象とする。
- 記事取得対象の日付 (`-d/--date` オプション) を指定しない場合は、**一年前の今日の日付**をデフォルト値として使用する。
- LLMを使って、年ごとの記事 (本文、タイトル、URL) を構造化したデータを渡し、振り返りができる文章を作る。振り返りは、以下のフォーマットが望ましい
- LLMでの生成以外はテストを書く (`pytest`)
  - 例えばHTMLなどは、取得したいくつかのHTMLを元にmock化して、bs4での抽出処理をおこなう、など

## 出力フォーマット例 (LLM生成部分)

```markdown
## 2024年4月29日 🍜

ラーメン横浜屋で、つけ麺を食べました。かなり好みの味で、また近々訪れたいと感じました。麺の太さとコシが絶妙で、スープも濃厚ながらくどさがなく、最後まで飽きずに完食。特に味玉の味付けが絶妙で感動しました。次回は違うメニューにも挑戦してみたいです。

## 2023年4月29日 🌊

大洗の海岸線を見ました。夕陽が美しく、何枚も写真を撮ったのですが、誤ってデータを消してしまい悲しかったです。それでも海風を感じながら過ごした時間は格別で、日常を忘れられるひとときでした。家族と一緒に行けたこともあり、素敵な思い出になりました。

...
```

## 出力ファイル

- 作成したテキストは、`output/texts/YYYYMMDD/{モデルベンダ}_{モデル名}.md` に保存する (YYYYMMDD は対象日)
- 抽出した年毎の記事画像(unique)を使い、日付と複数の画像を含めたpng画像を作る。この画像は `output/images/YYYYMMDD.png` (YYYYMMDD は対象日) に保存する。
  - 日本語を使うと文字化けするので、画像にフォントを埋め込む際は英語のみを使って。この画像は、人間が見た時にわかりやすい情報のレイアウトにして。できる限りマージンは入れないこと。
  - 各画像の右下に、記事の日付（YYYY.MM.DD形式）をオレンジ色の半透明小さめフォントで表示する。フォントサイズは12pxとする。
  - 画像上部のタイトル欄は表示しない。
  - 画像の背景色は `#333333`（ダークグレー）を使用する。
- 記事と画像の表示順序は、**新しい順（降順）**とする。

## 投稿機能

- `-p/--post` オプションで投稿先を指定できる (複数指定可: `discord`, `slack`, `stdout`)。
- 何も指定しない場合は `stdout` に出力する。
- discord, slack の場合、環境変数 (`.env` ファイル) からそれぞれの Webhook URL を読み込む。
  - `DISCORD_WEBHOOK_URL`
  - `SLACK_WEBHOOK_URL`
- 投稿時には、生成されたテキスト、画像、および各記事のメタデータ（URL、タイトル）を含む。

## 設定

- **環境変数 (.env):** APIキー (OpenAI, Google Gemini, Anthropic Claude) や Webhook URL など、プロジェクトで普遍的な設定。
- **コマンドライン引数:** 実行ごとに変わる可能性のある設定。
  - `-d, --date`: 対象日付 (YYYY-MM-DD形式, デフォルト: 一年前の今日)
  - `-m, --model`: LLMモデル (ベンダー/モデル名形式, デフォルト: `openai/gpt-4.1-nano`)
  - `-y, --years`: 遡る年数 (デフォルト: 10)
  - `-p, --post`: 投稿先 (複数指定可, デフォルト: `stdout`)
  - `-v, --verbose`: 詳細ログ出力
